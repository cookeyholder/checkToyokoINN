# spreadsheet-data Specification

## Purpose
TBD - created by archiving change add-room-availability-checker. Update Purpose after archive.
## Requirements
### Requirement: 試算表結構定義
系統 SHALL 使用預先建立的 Google Sheets 試算表,包含六個工作表。

#### Scenario: 試算表工作表結構
- **WHEN** 系統初始化或存取資料
- **THEN** 應存取以下六個工作表:
  - 東橫INN分店 (儲存分店名稱和編號)
  - 提醒清單 (儲存使用者建立的提醒)
  - 房型代號 (儲存房型名稱和 API 代號對照)
  - 檢查歷史 (記錄每次檢查的結果)
  - 網站參數設定 (儲存系統設定參數)
  - 帳號管理 (管理使用者帳號資訊)

### Requirement: 分店資料工作表
系統 SHALL 從「東橫INN分店」工作表讀取東橫 INN 各分店的名稱和編號。

#### Scenario: 分店資料欄位格式
- **WHEN** 讀取分店資料
- **THEN** 工作表名稱應為「東橫INN分店」
- **AND** 標題列 (第一列) 應為: 「分店名稱」、「分店編號」、「地區」、「都道府縣」
- **AND** 資料列格式為:
  - 欄 A: 分店名稱 (例如: "東京新宿店", "大阪梅田店")
  - 欄 B: 分店編號 (例如: "00066", "00123")
  - 欄 C: 地區 (例如: "關東", "關西")
  - 欄 D: 都道府縣 (例如: "東京都", "大阪府")

#### Scenario: 載入分店選項
- **WHEN** 網頁介面需要顯示分店下拉選單
- **THEN** 系統應讀取「東橫INN分店」工作表的所有資料列 (跳過第一列標題)
- **AND** 回傳包含分店名稱、編號、地區和都道府縣的陣列
- **AND** 資料格式為: `[{name: "東京新宿店", code: "00066", region: "關東", prefecture: "東京都"}, ...]`
- **AND** 前端下拉選單應顯示格式為: "分店名稱 (都道府縣)"

#### Scenario: 分店編號驗證
- **WHEN** 儲存新提醒時
- **THEN** 系統應驗證分店編號是否存在於「東橫INN分店」工作表中
- **AND** 如不存在應回傳清楚的錯誤訊息

### Requirement: 房型代號工作表
系統 SHALL 從「房型代號」工作表讀取房型名稱和對應的 API 代號。

#### Scenario: 房型代號欄位格式
- **WHEN** 讀取房型代號
- **THEN** 工作表應包含以下欄位:
  - 欄 A: 房型代號 (10, 20, 30, 40)
  - 欄 B: 房型名稱 (單人房, 雙人房, 雙床房, 三人以上房)

#### Scenario: 房型代號映射
- **WHEN** 建構房間查詢 URL
- **THEN** 系統應根據使用者選擇的房型名稱
- **AND** 查找對應的房型代號
- **AND** 使用代號作為 API 參數

#### Scenario: 房型選項載入
- **WHEN** 網頁介面初始化
- **THEN** 系統應從房型代號工作表載入所有房型選項
- **AND** 在下拉選單中顯示房型名稱

### Requirement: 提醒清單工作表
系統 SHALL 在「提醒清單」工作表中儲存、讀取和刪除提醒資料。

#### Scenario: 提醒清單欄位格式
- **WHEN** 存取提醒清單
- **THEN** 工作表應包含以下欄位 (按順序):
  - 欄 A: 分店編號
  - 欄 B: 分店名稱
  - 欄 C: 房型代號
  - 欄 D: 房型名稱
  - 欄 E: 成人人數
  - 欄 F: 房間數
  - 欄 G: 入住日期
  - 欄 H: 退房日期
  - 欄 I: 提醒開始時間
  - 欄 J: 提醒結束時間
  - 欄 K: 使用者 Email
  - 欄 L: 建立時間
  - 欄 M: 最後通知時間 (選用)
  - 欄 N: 通知狀態 (選用)
  - 欄 O: 提醒狀態 ("啟用"/"暫停", 預設: "啟用")

#### Scenario: 讀取所有提醒
- **WHEN** 系統需要載入提醒清單
- **THEN** 應讀取提醒清單工作表的所有資料列 (跳過標題列)
- **AND** 將每列轉換為提醒物件
- **AND** 回傳提醒物件陣列

#### Scenario: 新增提醒
- **WHEN** 使用者建立新提醒
- **THEN** 系統應在提醒清單工作表的最後一列新增資料
- **AND** 填入所有必要欄位
- **AND** 每筆記錄僅包含一個房型代號和房型名稱
- **AND** 記錄當前使用者的 Email (Session.getActiveUser().getEmail())
- **AND** 記錄當前時間為建立時間

#### Scenario: 複選房型處理
- **WHEN** 使用者在前端選擇多個房型
- **THEN** 系統應為每個選擇的房型建立獨立的提醒記錄
- **AND** 每筆記錄使用相同的分店、日期、人數等資訊
- **AND** 僅房型代號和房型名稱不同

#### Scenario: 刪除提醒
- **WHEN** 使用者刪除特定提醒
- **THEN** 系統應根據提醒的唯一識別 (例如: 列號或組合鍵)
- **AND** 從工作表中刪除對應的列

#### Scenario: 更新提醒狀態
- **WHEN** 系統發送通知後
- **THEN** 應更新該提醒的「最後通知時間」欄位
- **AND** 更新「通知狀態」欄位

### Requirement: 試算表 ID 設定
系統 SHALL 使用設定檔或腳本屬性儲存試算表 ID。

#### Scenario: 讀取試算表 ID
- **WHEN** 系統需要存取試算表
- **THEN** 應從 PropertiesService 或程式碼常數讀取試算表 ID
- **AND** 使用 SpreadsheetApp.openById() 開啟試算表

#### Scenario: 試算表不存在
- **WHEN** 指定的試算表 ID 無效或無法存取
- **THEN** 系統應拋出清楚的錯誤訊息
- **AND** 引導使用者檢查試算表 ID 設定

### Requirement: 資料驗證
系統 SHALL 在讀寫試算表資料時進行基本驗證。

#### Scenario: 驗證必填欄位
- **WHEN** 寫入提醒資料
- **THEN** 系統應驗證所有必填欄位已填寫
- **AND** 資料格式正確 (例如: 日期格式、數字範圍)

#### Scenario: 驗證日期邏輯
- **WHEN** 儲存提醒
- **THEN** 應驗證退房日期至少比入住日期晚 1 天
- **AND** 入住日期不早於今天
- **AND** 退房日期不早於今天

#### Scenario: 驗證時間邏輯
- **WHEN** 儲存提醒
- **THEN** 應驗證時間格式為 HH:MM
- **AND** 時間值在 00:00 到 23:59 範圍內

#### Scenario: 驗證日期間隔
- **WHEN** 儲存提醒
- **THEN** 應計算退房日期與入住日期的天數差
- **AND** 天數差必須至少為 1 天
- **AND** 如不符合應回傳錯誤訊息: "退房日期必須至少比入住日期晚 1 天"

### Requirement: 檢查歷史記錄
系統 SHALL 在「檢查歷史」工作表中記錄每次房間檢查的結果。

#### Scenario: 檢查歷史欄位格式
- **WHEN** 記錄檢查歷史
- **THEN** 工作表應包含以下欄位:
  - 欄 A: 提醒 ID (對應提醒清單的列號)
  - 欄 B: 檢查時間 (時間戳記 ISO 8601)
  - 欄 C: 檢查結果 ("有空房"/"無空房"/"錯誤")
  - 欄 D: 錯誤訊息 (如果檢查結果為"錯誤")
  - 欄 E: 是否發送通知 (TRUE/FALSE)

#### Scenario: 記錄檢查結果
- **WHEN** 完成一次房間可用性檢查
- **THEN** 系統應在檢查歷史工作表新增一列
- **AND** 填入檢查時間、結果和是否發送通知等資訊

#### Scenario: 記錄錯誤情況
- **WHEN** 檢查過程中發生錯誤
- **THEN** 應記錄為"錯誤"狀態
- **AND** 在錯誤訊息欄位記錄具體錯誤內容

#### Scenario: 歷史記錄查詢
- **WHEN** 使用者需要檢視某個提醒的檢查歷史
- **THEN** 系統應能根據提醒 ID 過濾並回傳相關記錄
- **AND** 按時間倒序排列 (最新的在前)

#### Scenario: 歷史記錄保留策略
- **WHEN** 系統運作一段時間後
- **THEN** 檢查歷史記錄應永久保存
- **AND** 不自動清理或刪除舊記錄
- **AND** 由使用者或管理員手動決定是否清理

### Requirement: 網站參數設定工作表
系統 SHALL 從「網站參數設定」工作表讀取系統運作所需的設定參數。

#### Scenario: 參數設定欄位格式
- **WHEN** 讀取網站參數設定
- **THEN** 工作表應包含以下欄位:
  - 欄 A: 參數項目 (例如: "檢查間隔時間", "冷卻時間", "API基礎 URL")
  - 欄 B: 參數內容 (對應的設定值)
  - 欄 C: 參數說明 (說明該參數的作用和格式)

#### Scenario: 讀取系統參數
- **WHEN** 系統需要取得設定參數
- **THEN** 應從網站參數設定工作表讀取對應的參數值
- **AND** 如參數不存在應使用預設值
- **AND** 記錄警告訊息到 Logger

#### Scenario: 常用參數範例
- **WHEN** 設定網站參數
- **THEN** 可包含以下參數:
  - 檢查間隔時間 (分鐘)
  - 通知冷卻時間 (小時)
  - 東橫 INN API 基礎 URL
  - 郵件通知啟用/停用
  - 最大提醒數量限制

### Requirement: 帳號管理工作表
系統 SHALL 使用「帳號管理」工作表管理使用者帳號資訊。

#### Scenario: 帳號管理欄位格式
- **WHEN** 存取帳號管理資料
- **THEN** 工作表應包含以下欄位:
  - 欄 A: Email (使用者電子郵件地址)
  - 欄 B: 姓名 (使用者姓名)
  - 欄 C: 人員編號 (員工或使用者編號)
  - 欄 D: 部門單位 (所屬部門)
  - 欄 E: 群組 (使用者所屬群組或角色)
  - 欄 F: 狀態 ("啟用"/"停用")
  - 欄 G: 備註 (額外說明資訊)

#### Scenario: 驗證使用者權限
- **WHEN** 使用者嘗試存取系統
- **THEN** 應檢查使用者 Email 是否在帳號管理工作表中
- **AND** 驗證帳號狀態為「啟用」
- **AND** 如不存在或已停用應拒絕存取

#### Scenario: 新增使用者帳號
- **WHEN** 需要新增使用者帳號
- **THEN** 應在帳號管理工作表新增一列
- **AND** 記錄使用者 Email、姓名、人員編號、部門單位和群組
- **AND** 預設狀態為「啟用」

#### Scenario: 停用使用者帳號
- **WHEN** 需要停用某個使用者
- **THEN** 應將該使用者的帳號狀態改為「停用」
- **AND** 該使用者無法再建立或管理提醒
- **AND** 該使用者的現有提醒繼續執行

