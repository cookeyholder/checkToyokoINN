# spreadsheet-data Specification Delta

## MODIFIED Requirements

### Requirement: 檢查歷史記錄
系統 SHALL 在「檢查歷史」工作表中記錄每次房間檢查的結果,並自動清理過多的歷史記錄以維持效能。

#### Scenario: 檢查歷史欄位格式
- **WHEN** 記錄檢查歷史
- **THEN** 工作表應包含以下欄位:
  - 欄 A: 提醒 ID (對應提醒清單的列號)
  - 欄 B: 檢查時間 (時間戳記 ISO 8601)
  - 欄 C: 檢查結果 ("有空房"/"無空房"/"錯誤")
  - 欄 D: 錯誤訊息 (如果檢查結果為"錯誤")
  - 欄 E: 是否發送通知 (TRUE/FALSE)

#### Scenario: 記錄檢查結果
- **WHEN** 完成一次房間可用性檢查
- **THEN** 系統應在檢查歷史工作表新增一列
- **AND** 填入檢查時間、結果和是否發送通知等資訊

#### Scenario: 記錄錯誤情況
- **WHEN** 檢查過程中發生錯誤
- **THEN** 應記錄為"錯誤"狀態
- **AND** 在錯誤訊息欄位記錄具體錯誤內容

#### Scenario: 歷史記錄查詢
- **WHEN** 使用者需要檢視某個提醒的檢查歷史
- **THEN** 系統應能根據提醒 ID 過濾並回傳相關記錄
- **AND** 按時間倒序排列 (最新的在前)

#### Scenario: 自動清理歷史記錄
- **WHEN** `checkAllReminders()` 完成所有提醒檢查並寫入檢查歷史後
- **THEN** 系統應檢查「檢查歷史」工作表的總列數 (包含標題列)
- **AND** 如果總列數超過 100,000 列
- **THEN** 應刪除第 2 列到第 97,000 列的資料
- **AND** 保留標題列 (第 1 列) 和最近約 3,000 筆記錄 (第 97,001 列到最後一列)
- **AND** 在 Logger 中記錄清理操作: "檢查歷史清理完成: 刪除 X 列,保留 Y 列"

#### Scenario: 清理操作錯誤處理
- **WHEN** 自動清理過程中發生錯誤
- **THEN** 系統應捕獲錯誤並記錄到 Logger
- **AND** 不影響正常的檢查歷史寫入功能
- **AND** 不中斷 `checkAllReminders()` 的執行

## REMOVED Requirements

### Requirement: 歷史記錄保留策略
**Reason**: 原本規定永久保存所有記錄,現改為自動清理以維持效能。

**Migration**: 系統會保留最近約 3,000 筆記錄,如需保存完整歷史,請在實施此變更前手動備份「檢查歷史」工作表。
