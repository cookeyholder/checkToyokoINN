<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ©« INN ç©ºæˆ¿ç›£æ§ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "Yu Gothic", sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--theme-primary, #f44336);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: var(--theme-primary, #f44336);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--theme-primary, #f44336);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #555;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: inherit;
            font-size: 14px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--theme-primary, #f44336);
            box-shadow: 0 0 5px var(--theme-shadow, rgba(244, 67, 54, 0.3));
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--theme-primary, #f44336);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--theme-primary-dark, #d32f2f);
        }

        .btn-secondary {
            background-color: #757575;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #616161;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .reminder-list {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }

        .reminder-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 4px solid var(--theme-primary, #f44336);
        }

        .reminder-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .reminder-card.paused {
            opacity: 0.7;
            border-top-color: #ccc;
        }

        .reminder-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .reminder-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .reminder-card-subtitle {
            font-size: 14px;
            color: #666;
        }

        .reminder-status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: var(--theme-light, #e3f2fd);
            color: var(--theme-primary, #1976d2);
            font-weight: 500;
        }

        .reminder-status-badge.paused {
            background-color: #f5f5f5;
            color: #999;
        }

        .reminder-card-body {
            margin-bottom: 15px;
        }

        .reminder-detail {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }

        .reminder-detail-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .reminder-expired {
            background-color: #fff3e0;
            color: #e65100;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 8px;
            display: inline-block;
        }

        .reminder-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .reminder-card-actions button {
            flex: 1;
            min-width: 70px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }

        .alert {
            padding: 15px;
            border-radius: 3px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-info {
            background-color: var(--theme-light, #e3f2fd);
            color: var(--theme-primary, #1976d2);
            border-left: 4px solid var(--theme-primary, #1976d2);
        }

        .alert-success {
            background-color: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 30px 20px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--theme-primary, #f44336);
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        .close-button:hover {
            color: var(--theme-primary, #f44336);
        }

        .history-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 3px;
            font-size: 13px;
            border-left: 3px solid var(--theme-primary, #f44336);
        }

        .history-time {
            color: #999;
            font-size: 12px;
        }

        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .status-tag.available {
            background-color: #c8e6c9;
            color: #2e7d32;
        }

        .status-tag.unavailable {
            background-color: #ffcccc;
            color: #c62828;
        }

        .status-tag.error {
            background-color: #ffe0b2;
            color: #e65100;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ¨ æ±æ©« INN ç©ºæˆ¿ç›£æ§ç³»çµ±</h1>
            <p>è‡ªå‹•ç›£æ§æˆ¿é–“å¯ç”¨æ€§,æœ‰ç©ºæˆ¿ç«‹å³é€šçŸ¥</p>
        </header>

        <div id="authMessage" style="display: none;" class="alert alert-error">
            æ‚¨ç„¡æ¬Šå­˜å–æ­¤ç³»çµ±ã€‚è«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚
        </div>

        <div id="mainContent">
            <div class="main-grid">
                <!-- æé†’å»ºç«‹è¡¨å–® -->
                <div class="panel">
                    <h2>æ–°å¢æé†’</h2>
                    <form id="reminderForm">
                        <div class="form-group">
                            <label for="region">åœ°å€ - éƒ½é“åºœç¸£ *</label>
                            <select id="region" required>
                                <option value="">è«‹é¸æ“‡åœ°å€...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="branch">æ±æ©« INN åˆ†åº— *</label>
                            <select id="branch" required disabled>
                                <option value="">è«‹å…ˆé¸æ“‡åœ°å€...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>æˆ¿å‹é¸æ“‡ * (å¯è¤‡é¸)</label>
                            <div class="checkbox-group" id="roomTypesContainer">
                                <!-- å‹•æ…‹ç”¢ç”Ÿ -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="adults">æˆäººäººæ•¸ *</label>
                            <input type="number" id="adults" min="1" max="4" value="2" required>
                        </div>

                        <div class="form-group">
                            <label for="rooms">æˆ¿é–“æ•¸ *</label>
                            <input type="number" id="rooms" min="1" max="4" value="1" required>
                        </div>

                        <div class="form-group">
                            <label for="checkInDate">å…¥ä½æ—¥æœŸ *</label>
                            <input type="date" id="checkInDate" required>
                        </div>

                        <div class="form-group">
                            <label for="checkOutDate">é€€æˆ¿æ—¥æœŸ *</label>
                            <input type="date" id="checkOutDate" required>
                        </div>

                        <div class="form-group">
                            <label for="startTime">æé†’é–‹å§‹æ™‚é–“ *</label>
                            <input type="datetime-local" id="startTime" required>
                        </div>

                        <div class="form-group">
                            <label for="endTime">æé†’çµæŸæ™‚é–“ *</label>
                            <input type="datetime-local" id="endTime" required>
                        </div>

                        <div class="button-group">
                            <button type="submit" class="btn-primary">å»ºç«‹æé†’</button>
                            <button type="reset" class="btn-secondary">æ¸…ç©ºè¡¨å–®</button>
                        </div>
                    </form>
                </div>

                <!-- æé†’æ¸…å–® -->
                <div class="panel">
                    <h2>å·²æ’ç¨‹çš„æé†’</h2>
                    <div id="reminderListContainer" class="reminder-list">
                        <div class="loading">æ­£åœ¨è¼‰å…¥æé†’æ¸…å–®...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ­·å²è¨˜éŒ„æ¨¡æ…‹çª— -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æª¢æŸ¥æ­·å²</h3>
                <button type="button" class="close-button" onclick="closeHistoryModal()">Ã—</button>
            </div>
            <div id="historyContent">
                <div class="loading">æ­£åœ¨è¼‰å…¥æ­·å²è¨˜éŒ„...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸç‹€æ…‹
        let branches = [];
        let roomTypes = [];
        let reminders = [];

        /**
         * éš¨æ©Ÿé¸æ“‡ä¸¦å¥—ç”¨é…è‰²ä¸»é¡Œ
         */
        function applyRandomTheme() {
            const themes = [
                { // 1: ç§‘æŠ€è—
                    primary: '#1e88e5',
                    primaryDark: '#1565c0',
                    light: '#e3f2fd',
                    shadow: 'rgba(30, 136, 229, 0.3)'
                },
                { // 2: æº«æš–çŠç‘š
                    primary: '#ff7f50',
                    primaryDark: '#ff6347',
                    light: '#ffe4e1',
                    shadow: 'rgba(255, 127, 80, 0.3)'
                },
                { // 3: æ«»èŠ±ç²‰
                    primary: '#ffb7c5',
                    primaryDark: '#e91e63',
                    light: '#fff5f7',
                    shadow: 'rgba(233, 30, 99, 0.3)'
                },
                { // 4: é™½å…‰é»ƒ
                    primary: '#ffc107',
                    primaryDark: '#ffa000',
                    light: '#fff9e6',
                    shadow: 'rgba(255, 193, 7, 0.3)'
                },
                { // 5: æ¸…æ–°è–„è·
                    primary: '#26a69a',
                    primaryDark: '#00897b',
                    light: '#e0f2f1',
                    shadow: 'rgba(38, 166, 154, 0.3)'
                },
                { // 6: æ·±ç´«ç¾…è˜­
                    primary: '#8e44ad',
                    primaryDark: '#6c3483',
                    light: '#f4ecf7',
                    shadow: 'rgba(142, 68, 173, 0.3)'
                },
                { // 7: ç¿¡ç¿ ç¶ 
                    primary: '#16a085',
                    primaryDark: '#117a65',
                    light: '#e8f8f5',
                    shadow: 'rgba(22, 160, 133, 0.3)'
                },
                { // 8: é…’ç´…è‰²
                    primary: '#a52a2a',
                    primaryDark: '#8b0000',
                    light: '#ffe6e6',
                    shadow: 'rgba(165, 42, 42, 0.3)'
                },
                { // 9: æ´»åŠ›æ©™
                    primary: '#f77f00',
                    primaryDark: '#d62828',
                    light: '#fff3e0',
                    shadow: 'rgba(247, 127, 0, 0.3)'
                },
                { // 10: æ¹–æ°´ç¶ 
                    primary: '#00b4d8',
                    primaryDark: '#0077b6',
                    light: '#e0f7fa',
                    shadow: 'rgba(0, 180, 216, 0.3)'
                },
                { // 11: æ·±æµ·è»è—
                    primary: '#003d5c',
                    primaryDark: '#002840',
                    light: '#e0f2f7',
                    shadow: 'rgba(0, 61, 92, 0.3)'
                },
                { // 12: å¤©ç©ºè—
                    primary: '#29b6f6',
                    primaryDark: '#0277bd',
                    light: '#e1f5fe',
                    shadow: 'rgba(2, 119, 189, 0.3)'
                },
                { // 13: ç«ç‘°é‡‘
                    primary: '#e0afa0',
                    primaryDark: '#b76e79',
                    light: '#fef5f5',
                    shadow: 'rgba(183, 110, 121, 0.3)'
                },
                { // 14: æ¹›è—
                    primary: '#1976d2',
                    primaryDark: '#0d47a1',
                    light: '#e3f2fd',
                    shadow: 'rgba(25, 118, 210, 0.3)'
                },
                { // 15: æ‘©å¡æ£•
                    primary: '#6f4e37',
                    primaryDark: '#5a3d2b',
                    light: '#f5ebe0',
                    shadow: 'rgba(111, 78, 55, 0.3)'
                }
            ];

            // éš¨æ©Ÿé¸æ“‡ä¸€å€‹ä¸»é¡Œ
            const theme = themes[Math.floor(Math.random() * themes.length)];

            // è¨­å®š CSS è®Šæ•¸
            document.documentElement.style.setProperty('--theme-primary', theme.primary);
            document.documentElement.style.setProperty('--theme-primary-dark', theme.primaryDark);
            document.documentElement.style.setProperty('--theme-light', theme.light);
            document.documentElement.style.setProperty('--theme-shadow', theme.shadow);
        }

        /**
         * åˆå§‹åŒ–é é¢
         */
        async function initPage() {
            // å…ˆå¥—ç”¨éš¨æ©Ÿä¸»é¡Œ
            applyRandomTheme();

            try {
                // æª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™
                // (ç¬¬ 5.2 éšæ®µç”±å¾Œç«¯å¯¦ä½œ)

                // è¼‰å…¥åˆ†åº—æ¸…å–®
                await loadBranches();

                // è¼‰å…¥æˆ¿å‹é¸é …
                await loadRoomTypes();

                // è¼‰å…¥æé†’æ¸…å–®
                await loadReminders();

                // è¨­å®šæ—¥æœŸé¸æ“‡å™¨æœ€å°å€¼
                setupDatePickers();

                // ç¶å®šäº‹ä»¶
                document.getElementById("reminderForm").addEventListener("submit", handleFormSubmit);
                document.getElementById("checkInDate").addEventListener("change", updateCheckOutMinDate);
                document.getElementById("checkOutDate").addEventListener("change", validateCheckOutDate);
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
            }
        }

        /**
         * è¼‰å…¥åˆ†åº—æ¸…å–®
         */
        async function loadBranches() {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler((data) => {
                    branches = data;
                    populateRegionSelect();
                    resolve();
                }).withFailureHandler((error) => {
                    console.error("è¼‰å…¥åˆ†åº—å¤±æ•—:", error);
                    reject(error);
                }).getBranchOptions();
            });
        }

        /**
         * å¡«å…¥åœ°å€ä¸‹æ‹‰é¸å–®
         */
        function populateRegionSelect() {
            const regionSelect = document.getElementById("region");
            regionSelect.innerHTML = '<option value="">è«‹é¸æ“‡åœ°å€...</option>';

            // ä¾åœ°å€å’Œéƒ½é“åºœç¸£åˆ†çµ„
            const groupedBranches = {};
            branches.forEach((branch) => {
                const region = branch.region || 'å…¶ä»–';
                const prefecture = branch.prefecture || 'æœªåˆ†é¡';
                const key = `${region}|${prefecture}`;

                if (!groupedBranches[key]) {
                    groupedBranches[key] = {
                        region: region,
                        prefecture: prefecture,
                        branches: []
                    };
                }
                groupedBranches[key].branches.push(branch);
            });

            // å»ºç«‹é¸é …ä¸¦æ’åº
            Object.keys(groupedBranches).sort((a, b) => {
                const [regionA, prefectureA] = a.split('|');
                const [regionB, prefectureB] = b.split('|');
                if (regionA !== regionB) {
                    return regionA.localeCompare(regionB, 'zh-TW');
                }
                return prefectureA.localeCompare(prefectureB, 'zh-TW');
            }).forEach((key) => {
                const group = groupedBranches[key];
                const option = document.createElement("option");
                option.value = key;
                option.textContent = `${group.region} - ${group.prefecture}`;
                regionSelect.appendChild(option);
            });

            // ç›£è½åœ°å€é¸æ“‡è®ŠåŒ–
            regionSelect.addEventListener('change', function () {
                populateBranchSelect(this.value);
            });
        }

        /**
         * å¡«å…¥åˆ†åº—ä¸‹æ‹‰é¸å–®
         */
        function populateBranchSelect(regionKey) {
            const branchSelect = document.getElementById("branch");

            if (!regionKey) {
                branchSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åœ°å€...</option>';
                branchSelect.disabled = true;
                return;
            }

            branchSelect.disabled = false;
            branchSelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†åº—...</option>';

            const [region, prefecture] = regionKey.split('|');

            // ç¯©é¸ä¸¦æ’åºåˆ†åº—
            const filteredBranches = branches
                .filter(branch => branch.region === region && branch.prefecture === prefecture)
                .sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));

            filteredBranches.forEach((branch) => {
                const option = document.createElement("option");
                option.value = branch.code;
                option.textContent = branch.name;
                branchSelect.appendChild(option);
            });
        }

        /**
         * è¼‰å…¥æˆ¿å‹é¸é …
         */
        async function loadRoomTypes() {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler((data) => {
                    roomTypes = data;
                    populateRoomTypes();
                    resolve();
                }).withFailureHandler((error) => {
                    console.error("è¼‰å…¥æˆ¿å‹å¤±æ•—:", error);
                    reject(error);
                }).getRoomTypeOptions();
            });
        }

        /**
         * å¡«å…¥æˆ¿å‹è¤‡é¸æ¡†
         */
        function populateRoomTypes() {
            const container = document.getElementById("roomTypesContainer");
            container.innerHTML = "";
            roomTypes.forEach((roomType) => {
                const wrapper = document.createElement("div");
                wrapper.className = "checkbox-item";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = roomType.code;
                checkbox.name = "roomType";
                checkbox.id = `roomType_${roomType.code}`;

                const label = document.createElement("label");
                label.htmlFor = `roomType_${roomType.code}`;
                label.textContent = roomType.name;

                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });
        }

        /**
         * è¨­å®šæ—¥æœŸé¸æ“‡å™¨æœ€å°å€¼
         */
        function setupDatePickers() {
            const today = new Date();
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");
            const startTimeInput = document.getElementById("startTime");
            const endTimeInput = document.getElementById("endTime");

            // è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
            const todayStr = formatDate(today);
            checkInInput.min = todayStr;
            checkOutInput.min = todayStr;

            // è¨­å®šé è¨­å€¼ç‚ºæ˜å¤©å’Œå¾Œå¤©
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dayAfterTomorrow = new Date(tomorrow);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 1);

            checkInInput.value = formatDate(tomorrow);
            checkOutInput.value = formatDate(dayAfterTomorrow);

            // è¨­å®šæé†’æ™‚é–“é è¨­å€¼ç‚ºç¾åœ¨å’Œä¸€é€±å¾Œ
            const now = new Date();
            const oneWeekLater = new Date(now);
            oneWeekLater.setDate(oneWeekLater.getDate() + 7);

            // æ ¼å¼åŒ–ç‚º datetime-local æ ¼å¼ (YYYY-MM-DDTHH:MM)
            const formatDateTimeLocal = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };

            startTimeInput.value = formatDateTimeLocal(now);
            endTimeInput.value = formatDateTimeLocal(oneWeekLater);

            updateCheckOutMinDate();
        }

        /**
         * å…¥ä½æ—¥æœŸè®Šæ›´æ™‚,æ›´æ–°é€€æˆ¿æ—¥æœŸæœ€å°å€¼
         */
        function updateCheckOutMinDate() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            if (checkInInput.value) {
                const checkInDate = new Date(checkInInput.value + "T00:00:00");
                const minCheckOutDate = new Date(checkInDate);
                minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);
                checkOutInput.min = formatDate(minCheckOutDate);

                // å¦‚æœé€€æˆ¿æ—¥æœŸæ—©æ–¼æœ€å°å€¼,è‡ªå‹•èª¿æ•´
                if (checkOutInput.value < checkOutInput.min) {
                    checkOutInput.value = checkOutInput.min;
                }
            }
        }

        /**
         * é©—è­‰é€€æˆ¿æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
         */
        function validateCheckOutDate() {
            const checkInInput = document.getElementById("checkInDate");
            const checkOutInput = document.getElementById("checkOutDate");

            if (checkInInput.value && checkOutInput.value) {
                const checkInDate = new Date(checkInInput.value + "T00:00:00");
                const checkOutDate = new Date(checkOutInput.value + "T00:00:00");

                if (checkOutDate <= checkInDate) {
                    showAlert("é€€æˆ¿æ—¥æœŸå¿…é ˆè‡³å°‘æ¯”å…¥ä½æ—¥æœŸæ™š 1 å¤©", "error");
                    // è‡ªå‹•èª¿æ•´ç‚ºå…¥ä½æ—¥æœŸ + 1 å¤©
                    const minCheckOutDate = new Date(checkInDate);
                    minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);
                    checkOutInput.value = formatDate(minCheckOutDate);
                    return false;
                }
            }
            return true;
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
         */
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        /**
         * è¼‰å…¥æé†’æ¸…å–®
         */
        async function loadReminders() {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler((data) => {
                    console.log('è¼‰å…¥æé†’è³‡æ–™:', data);
                    reminders = data;
                    displayReminders();
                    resolve();
                }).withFailureHandler((error) => {
                    console.error("è¼‰å…¥æé†’å¤±æ•—:", error);
                    showAlert("è¼‰å…¥æé†’æ¸…å–®å¤±æ•—", "error");
                    reject(error);
                }).getReminderList();
            });
        }

        /**
         * é¡¯ç¤ºæé†’æ¸…å–®
         */
        function displayReminders() {
            const container = document.getElementById("reminderListContainer");

            // ç¢ºä¿ reminders æ˜¯é™£åˆ—
            if (!reminders || !Array.isArray(reminders)) {
                reminders = [];
            }

            console.log('é¡¯ç¤ºæé†’:', reminders.length, 'ç­†');

            if (reminders.length === 0) {
                container.innerHTML =
                    '<div class="empty-state">ğŸ“‹ ç›®å‰æ²’æœ‰æ’ç¨‹çš„æé†’<br><small>æ–°å¢ä¸€å€‹é–‹å§‹ç›£æ§å§ï¼</small></div>';
                return;
            }

            // ä¾å…¥ä½æ—¥æœŸæ’åºï¼ˆè¿‘çš„åœ¨å‰ï¼‰
            const sortedReminders = [...reminders].sort((a, b) => {
                const dateA = new Date(a.checkInDate);
                const dateB = new Date(b.checkInDate);
                return dateA - dateB;
            });

            container.innerHTML = "";
            sortedReminders.forEach((reminder) => {
                const reminderUuid = reminder.uuid;
                if (!reminderUuid) {
                    console.warn('æé†’ç¼ºå°‘ UUIDï¼Œè·³éé¡¯ç¤º:', reminder);
                    return;
                }
                const isExpired = isDateExpired(reminder.checkOutDate);
                const card = document.createElement("div");
                card.className = `reminder-card ${reminder.reminderStatus === "æš«åœ" ? "paused" : ""}`;

                // å–å¾—æˆ¿å‹åç¨±ï¼ˆå„ªå…ˆä½¿ç”¨ reminder ä¸­çš„ roomTypeNameï¼‰
                const roomTypeName = reminder.roomTypeName ||
                    roomTypes.find((rt) => rt.code == reminder.roomTypeCode)?.name ||
                    `æˆ¿å‹ ${reminder.roomTypeCode}`;

                // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤ºï¼ˆæœ¬åœ°åŒ–æ ¼å¼ï¼‰
                const formatDateTime = (timeStr) => {
                    if (!timeStr) return '';

                    try {
                        // å¦‚æœ timeStr åŒ…å«å®Œæ•´æ—¥æœŸæ™‚é–“ (2025-01-15T09:00)
                        if (timeStr.includes('T')) {
                            const dt = new Date(timeStr);
                            if (isNaN(dt.getTime())) return timeStr;
                            return dt.toLocaleString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                        }

                        // å¦‚æœåªæœ‰æ™‚é–“ (HH:MM)
                        return timeStr;
                    } catch (e) {
                        return timeStr || '';
                    }
                };

                card.innerHTML = `
          <div class="reminder-card-header">
            <div>
              <div class="reminder-card-title">${reminder.branchName || 'æœªçŸ¥åˆ†åº—'}</div>
              <div class="reminder-card-subtitle">${roomTypeName}</div>
            </div>
            <span class="reminder-status-badge ${reminder.reminderStatus === "æš«åœ" ? "paused" : ""}">
              ${reminder.reminderStatus === "æš«åœ" ? "â¸ æš«åœ" : "â–¶ï¸ å•Ÿç”¨"}
            </span>
          </div>
          
          <div class="reminder-card-body">
            <div class="reminder-detail">
              <span class="reminder-detail-icon">ğŸ“…</span>
              <span>${reminder.checkInDate} â†’ ${reminder.checkOutDate}</span>
            </div>
            <div class="reminder-detail">
              <span class="reminder-detail-icon">ğŸ‘¥</span>
              <span>${reminder.adults || 1} ä½æˆäºº Â· ${reminder.rooms || 1} é–“æˆ¿</span>
            </div>
            <div class="reminder-detail">
              <span class="reminder-detail-icon">ğŸ•</span>
              <span>${formatDateTime(reminder.startTime)} ~ ${formatDateTime(reminder.endTime)}</span>
            </div>
            ${isExpired ? '<div class="reminder-expired">âš ï¸ æ­¤æé†’å·²éæœŸ</div>' : ""}
          </div>
          
          <div class="reminder-card-actions">
                        <button type="button" class="btn-small btn-secondary" onclick="toggleReminderStatus('${reminderUuid}')">
              ${reminder.reminderStatus === "æš«åœ" ? "å•Ÿç”¨" : "æš«åœ"}
            </button>
                        <button type="button" class="btn-small btn-secondary" onclick="viewHistory('${reminderUuid}')">
              æ­·å²
            </button>
                        <button type="button" class="btn-small btn-primary" onclick="deleteReminder('${reminderUuid}')">
              åˆªé™¤
            </button>
          </div>
        `;

                container.appendChild(card);
            });
        }

        /**
         * æª¢æŸ¥æ—¥æœŸæ˜¯å¦å·²éæœŸ
         */
        function isDateExpired(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const checkDate = new Date(dateStr + "T00:00:00");
            return checkDate < today;
        }

        /**
         * è¡¨å–®æäº¤è™•ç†
         */
        async function handleFormSubmit(e) {
            e.preventDefault();

            try {
                // é©—è­‰é€€æˆ¿æ—¥æœŸ
                if (!validateCheckOutDate()) {
                    return;
                }

                // é©—è­‰æˆ¿å‹é¸æ“‡
                const selectedRoomTypes = Array.from(
                    document.querySelectorAll('input[name="roomType"]:checked')
                ).map((cb) => ({
                    code: cb.value.toString(), // è½‰ç‚ºå­—ä¸²
                    name: roomTypes.find((rt) => rt.code == cb.value)?.name,
                }));

                if (selectedRoomTypes.length === 0) {
                    showAlert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æˆ¿å‹", "error");
                    return;
                }

                // æ”¶é›†è¡¨å–®è³‡æ–™ï¼ˆå…¨éƒ¨è½‰ç‚ºå­—ä¸²ï¼‰
                const formData = {
                    branchCode: document.getElementById("branch").value,
                    branchName: branches.find((b) => b.code === document.getElementById("branch").value)?.name,
                    roomTypes: selectedRoomTypes,
                    adults: document.getElementById("adults").value.toString(),
                    rooms: document.getElementById("rooms").value.toString(),
                    checkInDate: document.getElementById("checkInDate").value,
                    checkOutDate: document.getElementById("checkOutDate").value,
                    startTime: document.getElementById("startTime").value,
                    endTime: document.getElementById("endTime").value,
                };

                console.log('é–‹å§‹æäº¤è¡¨å–®:', formData);

                // æäº¤åˆ°å¾Œç«¯ï¼ˆæˆåŠŸå¾Œé‡æ–°è¼‰å…¥æé†’åˆ—è¡¨ï¼‰
                google.script.run
                    .withSuccessHandler((result) => {
                        console.log('æäº¤æˆåŠŸï¼Œé‡æ–°è¼‰å…¥æé†’åˆ—è¡¨');
                        showAlert("âœ… æé†’å·²å»ºç«‹", "success");
                        // é‡æ–°è¼‰å…¥æé†’åˆ—è¡¨è€Œä¸æ˜¯æ•´å€‹é é¢
                        loadReminders();
                        // é‡ç½®è¡¨å–®
                        document.getElementById("reminderForm").reset();
                    })
                    .withFailureHandler((error) => {
                        console.error('æäº¤å¤±æ•—:', error);
                        showAlert(`âŒ æäº¤å¤±æ•—: ${error.message || error}`, "error");
                    })
                    .submitReminder(formData);
            } catch (error) {
                showAlert(`è¡¨å–®é©—è­‰å¤±æ•—: ${error.message}`, "error");
                console.error(error);
            }
        }

        /**
         * åˆ‡æ›æé†’ç‹€æ…‹
         */
        async function toggleReminderStatus(reminderUuid) {
            const reminder = reminders.find((item) => item.uuid === reminderUuid);
            if (!reminder) {
                console.error('æ‰¾ä¸åˆ°æé†’ï¼ŒUUID:', reminderUuid);
                showAlert('æ‰¾ä¸åˆ°æé†’è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                return;
            }
            const newStatus = reminder.reminderStatus === "æš«åœ" ? "å•Ÿç”¨" : "æš«åœ";

            console.log(`åˆ‡æ›æé†’ç‹€æ…‹: UUID=${reminderUuid}, ç›®å‰ç‹€æ…‹=${reminder.reminderStatus}, æ–°ç‹€æ…‹=${newStatus}`);

            google.script.run.withSuccessHandler(() => {
                console.log('ç‹€æ…‹æ›´æ–°æˆåŠŸï¼Œé‡æ–°è¼‰å…¥æé†’æ¸…å–®');
                showAlert(`å·²${newStatus === "æš«åœ" ? "æš«åœ" : "å•Ÿç”¨"}æé†’`, "success");
                // å…ˆæ›´æ–°æœ¬åœ°ç‹€æ…‹ï¼Œç¢ºä¿å³æ™‚åæ˜ 
                reminder.reminderStatus = newStatus;
                // ç„¶å¾Œé‡æ–°è¼‰å…¥ä»¥ç¢ºä¿è³‡æ–™åŒæ­¥
                loadReminders();
            }).withFailureHandler((error) => {
                console.error('ç‹€æ…‹æ›´æ–°å¤±æ•—:', error);
                showAlert(`æ›´æ–°å¤±æ•—: ${error}`, "error");
            }).toggleReminderStatus(reminderUuid, newStatus);
        }

        /**
         * åˆªé™¤æé†’
         */
        function deleteReminder(reminderUuid) {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æé†’å—ï¼Ÿ")) {
                return;
            }

            const reminder = reminders.find((item) => item.uuid === reminderUuid);
            if (!reminder) {
                console.error('æ‰¾ä¸åˆ°æé†’ï¼ŒUUID:', reminderUuid);
                showAlert('æ‰¾ä¸åˆ°æé†’è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                return;
            }

            google.script.run.withSuccessHandler(() => {
                showAlert("æé†’å·²åˆªé™¤", "success");
                loadReminders();
            }).withFailureHandler((error) => {
                showAlert(`åˆªé™¤å¤±æ•—: ${error}`, "error");
            }).deleteReminder(reminderUuid);
        }

        /**
         * æª¢è¦–æ­·å²è¨˜éŒ„
         */
        /**
         * æª¢è¦–æ­·å²è¨˜éŒ„
         */
        function viewHistory(reminderUuid) {
            const reminder = reminders.find((item) => item.uuid === reminderUuid);
            if (!reminder) {
                console.error('æ‰¾ä¸åˆ°æé†’ï¼ŒUUID:', reminderUuid);
                showAlert('æ‰¾ä¸åˆ°æé†’è³‡æ–™ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                return;
            }
            console.log('æŸ¥çœ‹æ­·å²è¨˜éŒ„ - æé†’ UUID:', reminderUuid, 'å°æ‡‰æé†’:', reminder);
            document.getElementById("historyModal").style.display = "block";
            document.getElementById("historyContent").innerHTML = '<div class="loading">æ­£åœ¨è¼‰å…¥...</div>';

            console.log(`æŸ¥çœ‹æ­·å²è¨˜éŒ„: UUID=${reminder.uuid}`);

            google.script.run.withSuccessHandler((history) => {
                const historyRecords = Array.isArray(history) ? history : [];
                console.log('å–å¾—æ­·å²è³‡æ–™:', historyRecords);

                if (historyRecords.length === 0) {
                    document.getElementById("historyContent").innerHTML =
                        '<div class="empty-state">å°šç„¡æª¢æŸ¥è¨˜éŒ„</div>';
                    return;
                }

                let html = "";
                historyRecords.forEach((record) => {
                    const statusClass = record.status === "æœ‰ç©ºæˆ¿" ? "available" : record.status === "ç„¡ç©ºæˆ¿" ? "unavailable" : "error";
                    html += `
            <div class="history-item">
              <div class="history-time">${new Date(record.checkTime).toLocaleString("zh-TW")}</div>
              æª¢æŸ¥çµæœ: <span class="status-tag ${statusClass}">${record.status}</span>
              ${record.notificationSent ? "âœ‰ï¸ å·²é€šçŸ¥" : ""}
              ${record.errorMessage ? `<br>éŒ¯èª¤: ${record.errorMessage}` : ""}
            </div>
          `;
                });
                document.getElementById("historyContent").innerHTML = html;
            }).withFailureHandler((error) => {
                console.error('è¼‰å…¥æ­·å²å¤±æ•—:', error);
                document.getElementById("historyContent").innerHTML =
                    `<div class="alert alert-error">è¼‰å…¥å¤±æ•—: ${error}</div>`;
            }).getCheckHistoryByUuid(reminder.uuid);
        }

        /**
         * é—œé–‰æ­·å²è¨˜éŒ„æ¨¡æ…‹çª—
         */
        function closeHistoryModal() {
            document.getElementById("historyModal").style.display = "none";
        }

        /**
         * é¡¯ç¤ºæç¤ºè¨Šæ¯
         */
        function showAlert(message, type = "info") {
            // ç°¡å–®å¯¦ä½œ,å¯æ”¹ç‚º toast é€šçŸ¥
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;

            const container = document.querySelector(".container");

            if (container) {
                // ä½¿ç”¨ prepend æ›´å®‰å…¨,ç›´æ¥åŠ åˆ°é–‹é ­
                container.prepend(alertDiv);
            } else {
                // å¦‚æœ container ä¸å­˜åœ¨,åŠ åˆ° body é–‹é ­
                document.body.prepend(alertDiv);
            }

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener("load", initPage);

        // é»æ“Šæ¨¡æ…‹çª—å¤–éƒ¨é—œé–‰
        window.addEventListener("click", (event) => {
            const modal = document.getElementById("historyModal");
            if (event.target === modal) {
                closeHistoryModal();
            }
        });
    </script>
</body>

</html>